/****
* Author: King County Web Team
* Date: 4/1/2014
* Description: King County custom JS files
****/

$(document).ready(function () {
    /****
    * Name: Jeff Hsu
    * Date: 11/26/2013
    ***/
    $("[data-kccomponent]").each(function () {
        var $this = $(this),
        url = $this.data("kccomponent") + '.aspx?a=true';
        $this.html("");

        $.ajax({
            type: 'GET',
            url: url
        }).done(function (data) {
            $this.append(data);

            //for datedlist popovers          
            $(".popoveritem").popover();

        });
    });
    /* Sidemenu initialize http://getbootstrap.com/examples/offcanvas/*/
    $('[data-toggle=offcanvas]').click(function() {
        $('.row-offcanvas').toggleClass('active');
    });
    //Delay on nav dropdown menu
    $("ul.nav li.dropdown").hover(
    function () {
        var $this = $(this).children("ul.dropdown-menu");
        var timer = $this.data("timer") || 0;
        clearTimeout(timer);
        timer = setTimeout(function () {
            $this.addClass("show");
        }, 250); // 2000 is in mil sec eq to 2 sec.
        $this.data("timer", timer);
    },
    function () {
        var $this = $(this).children("ul.dropdown-menu");
        var timer = $this.data("timer") || 0;
        clearTimeout(timer);
        timer = setTimeout(function () {
            $this.removeClass("show");
        }, 250);
        $this.data("timer", timer);
    });
    //Footer collapse menus
    if($("#nav-xs").css("display") == "none"){
       $("#footer-nav .col-sm-4 ul").collapse('show');
    }
    else {
        $("#footer-nav .col-sm-4 ul").collapse('hide');
    }

    $("#footer-nav .col-sm-4 h4").each(function( index ){
        $(this).click(function(event){
            event.preventDefault();
            if($("#nav-xs").css("display") == "block") {
                
                //check ie8
                if (!Modernizr.mq('only all')) {
                    $(this).next().toggleClass("collapse");
                }
                else {
                    $(this).next().collapse("toggle");
                }
                $(this).find("i").toggleClass("fa-minus").toggleClass("fa-plus");
            }
        });
    });
    //Description: Script for hidding links in global navigation dropdown menu
    $('.hidden-link').hide();
    $('a.toggle-hidden-links').click(function () {
        if ($(this).hasClass("open")) {
            $('.hidden-link').hide("fast")
            $(this).removeClass('open');
        }
        else {
            $('.hidden-link').hide("fast")
            $('a.toggle-hidden-links').removeClass('open');
            $(this).closest('ul').children('.hidden-link').show("fast");
            $(this).addClass('open');
        }
    });
    //Main-content fade upon hovering over main nav
    //Update: 7/25/2013, Added code to test for touch device.
    if (!is_touch_device()) {
        $("header .navbar .dropdown-toggle").hover(
            function (e) {
                $('#main-content').stop(true).fadeTo(300, .3);
                $('#home-content').stop(true).fadeTo(300, .3);
            },
            function (e) {
                $('#main-content').stop(true).fadeTo(300, 1);
                $('#home-content').stop(true).fadeTo(300, 1);
            }
            );
        $("header .dropdown-menu").hover(
            function (e) {
                $('#main-content').stop(true).fadeTo(300, .3);
                $('#home-content').stop(true).fadeTo(300, .3);
            },
            function (e) {
                $('#main-content').stop(true).fadeTo(300, 1);
                $('#home-content').stop(true).fadeTo(300, 1);
            }
        );
    }
    else {
        $(".navbar  a.dropdown-toggle").click(function (event) {
            event.preventDefault();
            $(".dropdown-toggle").removeClass("disabled");
        })
    }
    function is_touch_device() {
        return 'ontouchstart' in window // works on most browsers 
      || 'onmsgesturechange' in window; // works on ie10
    }
    // Force touch screens to remove the menu when touching body of page
    $("#main-content").click(function () {
        $(".dropdown-toggle").removeClass("show");
    });
    /* Prevent Safari opening links when viewing as a Mobile App */
    (function (a, b, c) {
        if (c in b && b[c]) {
            var d, e = a.location,
                f = /^(a|html)$/i;
            a.addEventListener("click", function (a) {
                d = a.target;
                while (!f.test(d.nodeName)) d = d.parentNode;
                "href" in d && (d.href.indexOf("http") || ~d.href.indexOf(e.host)) && (a.preventDefault(), e.href = d.href)
            }, !1)
        }
    })(document, window.navigator, "standalone");

    /* Prevent click event on empty a href tags */
    $("a[href='#']").click(function (event) {
        event.preventDefault();
    });

    // Yamm menu setup
    $(document).on('click', '.yamm .dropdown-menu', function(e) {
        e.stopPropagation()
    })
    //Sidebar nav indenting
    //Only works up to four levels deep
    //Also includes fix for active item
    $("#sidebar .panel .list-group.collapsed").find('a.list-group-item').each(function () {
        $(this).css("padding-left", "+=10");
    });
    $("#sidebar .panel .list-group.collapsed > .list-group.collapsed").find('a.list-group-item').each(function () {
        $(this).css("padding-left", "+=10");
    });
    $("#sidebar .panel .list-group.collapsed >.list-group.collapsed > .list-group.collapsed").find('a.list-group-item').each(function () {
        $(this).css("padding-left", "+=10");
    });
     $("#sidebar .panel .list-group.collapsed > .list-group.collapsed > .list-group.collapsed > .list-group.collapsed").find('a.list-group-item').each(function () {
        $(this).css("padding-left", "+=10");
    });
    var activeSidebarItem = $(".sidebar-offcanvas .list-group-item.active");
    $(activeSidebarItem).each(function( index) {
      $(this).css("padding-left", "-=6");
    });
    $('#sticky-footer').scrollToFixed( {
    bottom: 0, 
    limit: $('#footer-nav-limit').offset().top,
    fixed: function () {
        $(this).css('display', 'block');
        $(this).css('width', '100%');
    },
    unfixed: function () {
       $(this).css('display', 'none');
    },
    dontSetWidth: false
    });

    /****
    * Set up for addthis sharing button
    * Need King County PubID to gather stats http://support.addthis.com/customer/portal/articles/381265-addthis-sharing-endpoints#twitter
    ****/

    $('a#facebook-share-button').click(function (event) {
        event.preventDefault();
        var pathname = $(location).attr('href');
        var left = ($(window).width() / 2) - (700 / 2);
        var top = ($(window).height() / 2) - (325 / 2);
        try {
            window.open('http://api.addthis.com/oexchange/0.8/forward/facebook/offer?url=' + pathname, 'Facebook popup', 'scrollbars=no, height=325, width=700, top=' + top + ', left=' + left);
        }
        catch (e) {
            window.open('http://api.addthis.com/oexchange/0.8/forward/facebook/offer?url=' + pathname, 'Facebookpopup');
        }
        return false;

    });

    $('a#twitter-share-button').click(function (event) {
        event.preventDefault();
        var pathname = $(location).attr('href');
        var left = ($(window).width() / 2) - (700 / 2);
        var top = ($(window).height() / 2) - (325 / 2);
        try {
            window.open('http://api.addthis.com/oexchange/0.8/forward/twitter/offer?url=' + pathname, 'Twitter popup', 'scrollbars=no, height=325, width=700, top=' + top + ', left=' + left);
        }
        catch (e) {
            window.open('http://api.addthis.com/oexchange/0.8/forward/twitter/offer?url=' + pathname, 'Twitterpopup');
        }
        return false;

    });
    $('a#email-share-button').click(function (event) {
        event.preventDefault();
        var pathname = $(location).attr('href');
        var left = ($(window).width() / 2) - (700 / 2);
        var top = ($(window).height() / 2) - (325 / 2);
        try {
            window.open('http://api.addthis.com/oexchange/0.8/forward/email/offer?url=' + pathname, 'Email popup', 'scrollbars=no,height=525,width=700,top=' + top + ',left=' + left);
        }
        catch (e) {
            window.open('http://api.addthis.com/oexchange/0.8/forward/email/offer?url=' + pathname, 'Emailpopup');
        }
        return false;

    });
    $('a#print-share-button').click(function (event) {
        event.preventDefault();
        var loc = encodeURI(window.location);
        window.open(loc + "?print=1", "_self");
        return false;
    });
    //http://getbootstrap.com/getting-started/#support-ie10-width
    if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
        var msViewportStyle = document.createElement('style')
        msViewportStyle.appendChild(
            document.createTextNode(
            '@-ms-viewport{width:auto!important}'
            )
        )
        document.querySelector('head').appendChild(msViewportStyle)
    }
    //Initialize Fitvids
    $("#main-content").fitVids();
    //*<![CDATA[
     /* var usasearch_config = { siteHandle:"kingcounty" };
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src = "http://search.usa.gov/javascripts/remote.loader.js";
      document.getElementsByTagName("head")[0].appendChild(script);
      */
    //]]>
    //Crazy Egg tracking code
    /*
    setTimeout(function () {
        var a = document.createElement("script");
        var b = document.getElementsByTagName("script")[0];
        a.src = document.location.protocol + "http://dnn506yrbagrg.cloudfront.net/pages/scripts/0013/1306.js?" + Math.floor(new Date().getTime() / 3600000);
        a.async = true; a.type = "text/javascript"; b.parentNode.insertBefore(a, b)
    }, 1);*/
});


$(window).resize(function() {
    //Collapse window on resize
    if($("#nav-xs").css("display") == "none"){
       $("#footer-nav .col-sm-4 ul").collapse('show');
    }
    else {
        $("#footer-nav .col-sm-4 ul").collapse('hide');
    }
}).resize(); // trigger resize handlers
  
//Funciton to choose Background on body
var xsSet = false;
var lgSet = false;
function chooseBG(imgMobile, imgDesktop) {
    if(imgMobile && ($('#nav-xs').css("display") == "block") && xsSet == false){
        $('#mobile-bg').attr("src", imgMobile);
        xsSet = true;
    }
    if(imgDesktop && ($('#nav-lg').css("display") == "block" || ($('#nav-sm').css("display") == "block")) && lgSet == false){
        $('body').css("background-image", "url('" + imgDesktop + "')");
        lgSet = true;
    }
}

//Calendar
function loadEventsCal(calDiv, calNum, numItemsToShow) {
    $.ajax({
        url: 'http://data.kingcounty.gov/resource/' + calNum + '.json?&$order=start_time&$$app_token=bCoT94x6NcBsw8AGGZudTwOs7',
        dataType: 'json',
        jsonp: false,
        success: function(data) {
            parseData(data, calDiv, numItemsToShow);
        },
        error: function () {
            crossDomainAjax('http://data.kingcounty.gov/resource/' + calNum + '.json?&$order=start_time&$$app_token=bCoT94x6NcBsw8AGGZudTwOs7', parseData, calDiv, numItemsToShow);
        }
    });  
}//end loadEventsCal()

function parseData(data, calDiv, numItemsToShow) {
    $(calDiv).addClass("calendar-events-list");
    var output = '<h2><span class="fa-stack"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-calendar fa-stack-1x fa-inverse"></i> </span> Events</h2>';
    var counter = 0;
    var allpops = [];
    $.each(data, function (i, item) {
        var date = new Date(0);
        date.setUTCSeconds(item.start_time);
        var currentDate = new Date();
        if (date >= currentDate && counter < numItemsToShow) {
            output+='<div class="media"><div class="pull-left">';
            var dateDay = date.getDate();
            output += '<div class=\"date-day\">' + dateDay + '</div> ';
            output += '<div class=\"date-month\">' + monthFormat(date.getMonth()) + '</div>';
            output += '</div>';//end pull left div
            var city;
            var address;
            var location;
            try {
                var itemLocation = $.parseJSON(item.location.human_address);
                city = itemLocation.city;
                address = itemLocation.address;
            } catch (e) {
                city = 'Not available';
                address = 'Not available';
            }
            if (item.location_name != undefined) {
                location = item.location_name;
            } else {
                location = 'Not available';
            }
            var popoverContent = 'Location: ' + location + '<br /> Address: ' + address + '<br /> City: ' + city;
            var url;
            try {
                url = item.url.url;
            } catch (e) {
                url = '\/about\/news\/events';
            }

            output += '<div class=\"media-body\">'
            var eventName;
            if(item.event_name.search('<') == 0){
                eventName = $(item.event_name).text();
            }
            else {
                eventName = item.event_name;
            }
            output += '<p><a class=\"pop\" id=\"popover' + i + '\"' + 'rel=\"popover\" data-animation=\"true\" data-html=\"true\" data-placement=\"top\" data-trigger=\"hover\" data-delay=\"0\"'; 
            output += 'data-content="' + popoverContent +'"';
            output += 'title=\"' + item.event_name +'"';
            output += 'href=\"'+ url +'"';
            output += '>' + eventName +'</a></p>';
            output += '</div></div>';//end media div
            allpops.push("#popover" + i);
            counter++;
        }
    });
    
    output += '<p class="all-events"><a href="/about/news/events"><em>See all events</em></a></p>';
    $(calDiv).html(output);
    $(allpops).each(function (index){
        $(allpops).popover();
    });
}//end parseData

//Helper function for Events Calendar function
function monthFormat(monthToFormat) {
    var month = new Array();
    month[0] = "JAN";
    month[1] = "FEB";
    month[2] = "MAR";
    month[3] = "APR";
    month[4] = "MAY";
    month[5] = "JUN";
    month[6] = "JUL";
    month[7] = "AUG";
    month[8] = "SEP";
    month[9] = "OCT";
    month[10] = "NOV";
    month[11] = "DEC";
    var formatedMonth = month[monthToFormat];
    return formatedMonth;
}//end monthFormat

function crossDomainAjax(url, successCallback, calDiv, numItemsToShow) {
    /* IE8 & 9 only Cross domain JSON GET request */
    if ('XDomainRequest' in window && window.XDomainRequest !== null) {
        var xdr = new XDomainRequest(); /* Use Microsoft XDR */
        /* 
        * XDomainRequest object requires a method for each event handler, 
        * even if anonymous, and to set properties explicitly
        */
        xdr.onload = function () {
            var JSON = $.parseJSON(xdr.responseText);

            if (JSON == null || typeof (JSON) == 'undefined') {
                JSON = $.parseJSON(data.firstChild.textContent);
            }

            successCallback(JSON, calDiv,numItemsToShow);
        };
        xdr.onprogress = function () { };
        xdr.ontimeout = function () { };
        xdr.onerror = function () {
            _result = false;
        };
        xdr.timeout = 5000;
        xdr.contenttype = 'text/plain';
        xdr.open('get', url);
        xdr.send();
    }

        /* Normal jQuery AJAX  */
    else {
        $.ajax({
            url: url,
            cache: false,
            dataType: 'json',
            type: 'GET',
            async: false,
            success: function (data, success) {
                successCallback(data, calDiv, numItemsToShow);
            },
            error: function () {
                /* regular embed, last resort */
                $(calDiv).addClass("calendar-events-list");
                var output = '';
                output += '<h2><span class="fa-stack"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-calendar fa-stack-1x fa-inverse"></i> </span> Events</h2><iframe width=\"100%\" title=\"Home page events, list view\" height=\"425px\" src=\"http://data.kingcounty.gov/w/2hap-jdfq/dhtr-ehd7?cur=fAUI6aKGxty&from=root\" frameborder=\"0\" scrolling=\"no\"><a href=\"//data.kingcounty.gov/Government/Home-page-events-list-view/2hap-jdfq\" title=\"Home page events, list view\" target=\"_blank\">Home page events, list view</a></iframe>';
                output += '<p class="all-events"><a href="/about/news/events"><em>See all events</em></a></p>';
                $(calDiv).html(output);

            }
        });
    }
}//end crossDomainAjax

//delicoiusFeed
function deliciousFeed(Div, feedURL, numItemsShow, summary) {
    var output = "";
    var allpops = [];
    var counter = 0;
    $.ajax({
        url: feedURL + '?count=' + numItemsShow,
        dataType: 'jsonp',
        success: function(data) {
            $(Div).addClass("news-feed");
            $(Div).addClass("dated-news-feed");

            output +='<h2><span class="fa-stack"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-file-text-o fa-stack-1x fa-inverse"></i></span>News</h2>';
            $.each (data, function(i, item) {
                var dateWhole = item.d.split(': ');
                var dateStrSub = dateWhole[0];
                var month = dateStrSub.split(' ')[0].toUpperCase();
                month = month.substring(0,3);
                var day = dateStrSub.split(' ')[1];
                //Start HTML string
                output += '<div class="media"><div class="pull-left">';
                //Get date in Date format
                //Get day
                output +='<div class="date-day">'+ day + '</div>';
                //Get month
                output +='<div class="date-month">'+ month + '</div>';
                output += '</div>';
                //Set content for popover
                var popoverContent = 'Summary: '+ item.n;  
                var titleStr = item.d;
                var titleParts = titleStr.split(': ');
                var titleStrSub = titleParts[1];
                //Get Event name
                output += '<div class="media-body">';
                output +='<a href="'+item.u+'" id="popover'+i+'" rel="popover" data-animation="true" data-html="true" data-placement="right" data-trigger="hover" data-delay="0" data-content="'+ popoverContent +'" title="'+ item.d +'">' + titleStrSub + '</a>';
                if(summary == "summary") {
                    output += '<p>'+item.n+'</p>';
                }
                //Wrap up
                output+='</div></div>';
                allpops.push("#popover"+i)
            });
            output+= '<p><a href="https://delicious.com/kingcounty"><em>See all King County news</em></a></p>'
             $(Div).html(output);
             $(allpops).each(function (index){
                $(allpops).popover();
             });
        }// end anon function
    });//end ajax
}//end deliciousFeed()   

